{% extends "core/base.html" %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% load static %}

{% block title %}
Filter Templates
{% endblock %}

{% block content %}
    <div class="container-fluid">
            <div class="card mt-3">
                <div class="card-header">
                    <b class="text-info">Template Title: {{ template.template_name }}</b>  
                    <form action="{% url "start" template.id %}" class="form-inline" method="get">
                        <input class="form-check-input" type="checkbox" name="save_template" value="yes" id="is_template">
                        <label class="form-check-label mr-2" for="is_template">
                        Commit as a template
                        </label>
                        <button type="submit" style="margin: 0 !important" class="btn btn-sm btn-outline-dark m-3">Start Oversight Mission</button>
                    </form>                  
                </div>

                <div class="card-body">
                    <table id="{{ template.id }}" data-order="[]" class="table table-sm table-bordered w-100" >
                        <thead>
                            <tr>
                                <th>Area</th>
                                <th>Expected Controls</th>
                                <th>Findings</th>
                                <th>Risk Severity</th>
                                <th>Recommendations</th>
                                <th>Management Comment</th>
                                <th>Target Implementation Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for section in sections %}
                            <tr>
                                <td colspan="7">
                                    <div class="alert alert-info" style="padding: 5px !important">{{ section.section_name }}</div>
                                </td>
                            </tr>
                            <tr>
                                <!-- Add existing Areas here -->
                                {% for area in areas %}
                                {% if area.section == section %}
                                <td class="area-field" contenteditable="true" field="area_name" data-id = "{{ area.id }}" >
                                        {% if area.area_name %}
                                        {{ area.area_name }}                            
                                        {% else %}
                                        &nbsp;
                                        {% endif %}
                                    </td>
                                <td class="area-field" contenteditable="true" field="expected_controls" data-id = "{{ area.id }}" >
                                        {% if area.expected_controls %}
                                        {{ area.expected_controls }}                            
                                        {% else %}
                                        &nbsp;
                                        {% endif %}
                                </td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                {% endif %}
                                {% endfor %}
                            </tr>
                            <tr>
                                <td colspan="7" class="text-center">
                                    <button class="btn btn-outline-primary btn-sm edit-btn text-left" data-toggle="collapse" data-target="#form-{{ section.id }}">Edit Area</button>
                                    <form id="form-{{ section.id }}" action="{% url "start" template.id %}" method="POST" class="collapse">
                                        {% csrf_token %}
                                        <div class="row">
                                            <input type="text" value="{{ template.id }}" hidden>
                                            {% for field in area_form %}
                                                <div class="form-group col-md-4">
                                                    {{ field|as_crispy_field }}
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="7" class="text-center p-2">
                                    <button class="btn btn-warning btn-block" data-toggle="collapse"
                                        data-target="#add-section-{{ template.id }}">Add Section</button>
                                    <form id="add-section-{{ template.id }}" action="{% url "edit_template" template.id %}" method="POST" class="collapse text-left">
                                        {% csrf_token %}
                                        <div class="row">
                                            <input type="text" value="{{  template.id }}" hidden>
                                            <input type="text" value="{{ section.id }}" hidden>
                                            {% for field in section_form %}
                                            <div class="form-group col-md-4">
                                                {{ field|as_crispy_field }}
                                            </div>
                                            {% endfor %}
                                            <div class="form-group col-md-4">
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary">Add Section</button>
                                    </form>
                                </td>
                            </tr>                            
                        </tbody>
                    </table>
                </div>
            </div>
    </div>
        <script src="{% static "core/js/jquery.min.js" %}"></script>
        <script src="{% static "core/js/bootstrap.min.js" %}"></script>
        <script src="{% static "core/js/datatables.min.js" %}"></script>
        <script src="{% static "core/data-tables/js/dataTables.bootstrap4.min.js" %}"></script>


    <script>
        function saveField(area_id, area_name, text, area_field){
            console.log(area_id+" "+area_name+" "+text);
            $.ajax({
                type: "get",
                url: "/edit/update_inline",
                data: {
                    area_id : area_id,
                    area_name : area_name,
                    text : text,
                },
    
                success: function (response) {
                    setTimeout(function(){
                        area_field.removeClass("loader");
                    }, 800)
                    console.log(response)    
                }
            });
        }
    
        $(document).ready(function () {
            $('#{{ template.id }}').DataTable({
                "targets": 'no-sort',
                "bSort": false,
                "order": []
            });

            $(".edit-btn").on("click", function(){
                if($(this).hasClass("collapsed")){
                    let area_id = $(this).attr("data-id")
                    // console.log(area_id)   
                    
                    $.ajax({
                        type: "get",
                        url: "/ajax/area_form",
                        data: {
                            area_id:area_id,
                        },
                        success: function (data, status){
                            // console.log(data)
                            let form = $(`#form-${area_id}-data`)
                            form.find("input[name='area_name']").val(data.area_name)
                            form.find("textarea[name='expected_controls']").val(data.expected_controls)
                            form.find("textarea[name='findings']").val(data.findings)
                            form.find("select[name='risk']").val(data.risk)
                            form.find("textarea[name='recommendation']").val(data.recommendation)
                            form.find("textarea[name='comment']").val(data.comment)
                            form.find("input[name='implementation_date']").val(data.implementation_date)
                            // let area2 = form.find(`#input-{{ area_id }}`)
                            console.log(data.expected_controls)
                        }
                    });
                }
            })
    
            let timer;
            let timeout = 1000;
    
            // $(".area-risk").on("click focus", function(){
            //     let risk = $(this)
            //     let risk_text = risk.find("span")
            //     risk.find("div").show()
            //     let risk_select = risk.find("select")
            //     risk_select.on("change", function(){
            //         console.log(risk_select.val())
            //         risk_text.text(risk_select.val().charAt(0).toUpperCase() + risk_select.val().slice(1))
            //         let area_name = risk.attr("field")
            //         let area_id = risk.attr("data-id")
            //         let text = risk_text.text().charAt(0).toLowerCase() + risk_text.text().slice(1)
            //         // console.log(area_name + )
            //         saveField(area_id, area_name, text)
            //     })
            //     // console.log(risk_select.val())
            // })
    
            // $(".area-risk").on("focusout", function(){
            //     let risk = $(this).find("div")
            //     risk.hide()
            //     console.log(risk.val())
            // })
    
            $(".area-field").on("focus", function(){
                console.log("focused");
                let area_field = $(this);
                if(area_field.text().match(/\w/) == null){
                    $(this).html("");
                }else{
                    //Nothing Continue Editing...
                }
            })
    
            $('.area-field').on("keyup focusout paste", function(){
                clearTimeout(timer);
                let area_field = $(this);
                    timer = setTimeout(function(){
                        let area_id = area_field.attr("data-id")
                        let area_name = area_field.attr("field")
                        let text = area_field.text().trim()
                        // if(area_name == "risk"){
                        //     console.log(area_name)
                        //     area_field.find("div").show();
                        // }
                        area_field.addClass("loader");
                        saveField(area_id, area_name, text, area_field)
                        
                    }, timeout);
            });
    
            $(".area-field").on("focusout", function(){
                let area_field = $(this).text()
                if(area_field == ""){
                    $(this).html('&nbsp;');
                }else{
    
                }
            })
        });
    </script>
{% endblock %}